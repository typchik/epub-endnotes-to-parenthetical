# Тестовые случаи EPUB Footnote Converter

## Поддерживаемые форматы сносок

### 1. Сноски в одном файле (множественные)
**Пример:** Лесков - Юдоль
- Файл: `ch2.xhtml` с заголовком "Примечания"
- Формат: `<span id="id11"><div><p>1</p></div><p>Текст сноски</p></span>`
- Ссылка: `<a href="ch2.xhtml#id11">[1]</a>`
- Количество: 13 сносок
- ✅ Статус: Работает

### 2. Каждая сноска в отдельном файле
**Пример:** Хенрик - Секрет успеха
- Файлы: `ch2-41.xhtml`, `ch2-42.xhtml`, ... (537 файлов)
- Формат: `<span id="id187"><div><p>41</p></div><p>Текст</p></span>`
- Размер файла: ~400 байт
- Ссылка: `<a href="ch2-41.xhtml#id187">[41]</a>`
- Особенность: Номер в ссылке [41] соответствует номеру в `<p>41</p>`
- ✅ Статус: Работает

### 3. Комментарии без номеров
**Пример:** Кери - Из первых рук  
- Файл: `ch2.xhtml` (60+ комментариев)
- Формат: `<span id="...">Текст комментария без номера</span>`
- Обнаружение: По количеству `<span id>` (>5)
- ✅ Статус: Работает

### 4. Сноски + Комментарии в одном файле
**Пример:** Белый - Петербург
- Файл: `ch2.xhtml` с заголовком "Сноски"
- Формат: Стандартный + фигурные скобки в ссылках
- Ссылка: `<a href="ch2.xhtml#id85" class="a">[1]</a>`
- ✅ Статус: Работает

### 5. Endnotes с отдельной нумерацией
**Пример:** Tim Urban - What's Our Problem
- Файл: `Endnotes.xhtml`
- Формат: `<p class="endnote" id="endnote-3"><span class="endNum">1</span>Текст</p>`
- Ссылка: `<a href="../Text/Endnotes.xhtml#endnote-3">1</a>`
- Особенность: ID (endnote-3) ≠ номер (1)
- ✅ Статус: Работает

### 6. Footnotes внутри страницы (aside)
**Пример:** Tim Urban - What's Our Problem
- Расположение: В том же файле
- Формат: `<aside id="footnote-ref-4" epub:type="footnote"><p class="footnote">Текст</p></aside>`
- Ссылка: `<a href="#footnote-ref-4">⬥</a>`
- ✅ Статус: Работает

### 7. Вложенные span (защита от ложных срабатываний)
**Пример:** Тул - Сговор остолопов
- Проблема: Главы содержат вложенные `<span id>`, которые НЕ являются сносками
- Решение: Обработка только файлов с ключевыми словами ("Примечания", "Notes", "Комментарии")
- Файл ch1-7.xhtml: 3 span, 27KB → **ПРОИГНОРИРОВАН** ✓
- Файл ch2.xhtml: 91 span + "Примечания" → **ОБРАБОТАН** ✓
- ✅ Статус: Работает

## Логика определения файлов со сносками

### Приоритет 1: Много span + ключевые слова
```
if (spanCount > 5 && hasKeywords) → extractFootnotes()
```
Пример: ch2.xhtml с 91 span и словом "Примечания"

### Приоритет 2: Мало span + ключевые слова  
```
if (hasKeywords && spanCount > 0 && spanCount <= 5) → extractFootnotes()
```
Пример: Файлы с 1-5 сносками и заголовком "Notes"

### Приоритет 3: Одиночные файлы
```
if (spanCount === 1 && fileSize < 5000) → extractSingleFootnote()
```
Пример: ch2-41.xhtml (428 байт, 1 span)

### Защита от глав
Файлы с span, но БЕЗ ключевых слов и размером >5KB игнорируются:
- ch1-7.xhtml (3 span, 27KB, нет "Примечания") → НЕ обрабатывается ✓

## Ограничения

### Длина сносок
- Максимум: 2000 символов
- Причина: Защита от обработки целых глав как одной сноски
- Если сноска длиннее 2000 символов → пропускается

### Размер файла (для одиночных)
- Максимум: 5000 байт
- Причина: Защита от обработки маленьких глав как сносок

## Статистика тестирования

| Формат | Книг протестировано | Статус |
|--------|---------------------|--------|
| Span + div (стандарт) | 4 | ✅ |
| Одиночные файлы | 1 | ✅ |
| Endnotes | 1 | ✅ |
| Footnotes (aside) | 1 | ✅ |
| Вложенные span | 1 | ✅ |
| **ВСЕГО** | **6** | **✅** |

## Как добавить новый тест-кейс

1. Найти проблемный EPUB
2. Определить структуру сносок:
   ```bash
   unzip file.epub
   grep -l "Примечания\|Notes" OPS/*.xhtml
   grep '<span[^>]*id=' OPS/ch2.xhtml | head -3
   ```
3. Добавить описание в этот файл
4. Протестировать конвертер
5. Если не работает → улучшить логику

## Известные edge cases

### ✅ Решено
- Вложенные span в главах (Тул)
- Несовпадение ID и номера (Tim Urban)
- Относительные пути (../Text/Endnotes.xhtml)
- Длинные сноски (Лесков - сноска №2 и №3)

### ⚠️ Потенциальные проблемы
- Сноски длиннее 2000 символов (текущий лимит)
- Файлы сносок размером >5KB с 1 span (будут проигнорированы)
- Нестандартные форматы, не использующие `<span id>` или `<p class="endnote">`
